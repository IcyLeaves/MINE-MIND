# 微信小程序

*summary*

<img src="微信小程序.assets/u=3402419394,2021076041&fm=11&gp=0.png" alt="u=3402419394,2021076041&fm=11&gp=0" style="zoom: 80%;" />

**微信小程序**的开发需要了解MINA框架，这是由微信官方开创的一套和Vue写法极其类似的前端框架，专门为微信小程序而生。

- 必须下载**微信开发者工具**以预览代码效果。如果不需要编译错误提示，可以选用**VSCode**来敲代码，因为这样可以利用一些插件。

---

*2020.12.23*

### 使用插件minapp时，格式化改用prettier

这是在VSCode写代码的时候产生的念头，主要是因为minapp默认的wxml格式化工具对超长的元素视而不见。既然插件也提供了prettier的工具，那就抱着试试看的心理尝试了一下，效果还不错。注意`"parser":"html"`不加上的话，prettier格式化会报错。

- 在`settings.json`中添加配置：

  ```json
  {
      "minapp-vscode.wxmlFormatter": "prettier",
      "minapp-vscode.prettier": {
          "parser":"html",
          "useTabs": false,
          "tabWidth": 2,
          "printWidth": 100,
          "singleQuote": false
      }
  }
  ```

### WXS语法知识1

#### 正则截取字符串

```javascript
var str='http://abc.com/a?id=B'
var code= str.match(/\?id=(.*)/)[1] //取?id=后面所有字符串
console.log(code) //B
```

#### 用that取代this关键字

``` javascript
someMethod(){
    var that=this
    wx.request({
        data:that.data.val //如果这里用this，指向的是wx.request（缩小了范围）
        ...
    })
}
```

---

*2020.12.29*

### 保留两位小数（补零）

- wxml无法执行js的方法，因此还是得wxs处理后再由wxml显示。

  ```js
  var a=1.2
  a.toFixed(2)//1.20 注意返回的是String类型
  ```

### setData的浅拷贝

- setData虽然能对当前页面的data进行赋值，但它实际上json对象的赋值是引用式的（**浅拷贝**），这会造成赋值来源可能会受到更改。

  ```js
  var global={
      a:1
  }
  this.setData({
      localData:global
  })
  console.log(global) //{a:1}
  this.setData({
      [`localData.a`]:2
  })
  console.log(global) //{a:2}
  ```

  - 这样如果`global`刚刚好是全局变量，那么其他页面下次再次引用全局变量时，值就会不一致。

- 一种方法是**深拷贝取代浅拷贝**，由于json内部成员的类型也比较简单，所以可以直接用一行简单命令：

  ```json
  var newCopy=JSON.parse(JSON.stringify(data));
  ```

  - > [关于JSON.parse(JSON.stringify(obj))实现深拷贝应该注意的坑](https://www.jianshu.com/p/b084dfaad501)

---

*2020.12.30*

### 微信小程序的支付实现

> [官方微信支付文档](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/payment/wx.requestPayment.html)

#### 准备工作

- 调用前需在[小程序微信公众平台](https://mp.weixin.qq.com/) -功能-微信支付入口申请接入微信支付

  - 微信商户号**mchid**

- 准备一个支付界面`/payment`
  - 有一个可以点击的支付按钮`<button>支付订单</button>`

  - 能接收上个页面传进来的订单值`orderInfo`

    - > [微信小程序——详细讲解页面传值(多种方法)](https://www.cnblogs.com/bushui/p/11633766.html)

#### 步骤1：用户下单，发起支付

第一步是要创建预支付交易单

- 在后端创建一个**生成预支付交易单**的接口，如`Res createWxOrder(Req entity)`

  - entity的结构至少包含：

    ```json
    {
        orderId:"1",
        openid:"2"
    }
    ```

  - 接口内的实现，JSON对象采用的是com.alibaba.fastjson系列，使用可参照[使用FastJSON 对Map/JSON/String 进行互相转换](https://blog.csdn.net/yyj108317/article/details/105137964)：

    ```java
    @Override
    public Map<String,Object> createWxOrder(WxOrderParam entity) {
        String orderURL="https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi";
        Map<String,Object> order=new HashMap<>();
        order.put("appid","w******5");
        order.put("mchid","1******0");
        order.put("description","测试付款功能");
        order.put("out_trade_no",entity.getOrderId());
        order.put("notify_url",);
        Map<String,Object> amount=new HashMap<>();
        amount.put("total",1);
        order.put("amount",amount);
        Map<String,Object> payer=new HashMap<>();
        payer.put("openid",entity.getOpenid());
        order.put("payer",payer);
    
        JSONObject req= new JSONObject(order);
        String req_str=JSON.toJSONString(req);
        String res_str= HttpUtil.postWithJson(orderURL, req, "utf-8");
        return JSON.parseObject(res_str);
    }
    ```

- 微信支付后台接收到这个预付单后，会返回一个非常重要的**预支付交易会话标识**`prepay_id`，用于后续接口调用，2小时内过期。

- 如果发生异常，则会返回异常码等。

#### 步骤2：进入支付流程

- 小程序端....

